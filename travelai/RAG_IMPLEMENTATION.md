# RAG (Retrieval-Augmented Generation) Implementation

## ğŸ¯ Overview

The WayFinder app now features an **AI-powered Retrieval-Augmented Generation (RAG) system** for intelligent route and bus stop detection. This allows users to search for routes using natural language queries.

## ğŸ—ï¸ Architecture

### Component Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              User Interface Layer               â”‚
â”‚         (intelligent_route_page.dart)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              RAG Service Layer                  â”‚
â”‚            (rag_service.dart)                   â”‚
â”‚  â€¢ Embedding Generation                         â”‚
â”‚  â€¢ Vector Similarity Search                     â”‚
â”‚  â€¢ Context Retrieval                            â”‚
â”‚  â€¢ LLM Integration                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Knowledge Base Layer                  â”‚
â”‚      (route_knowledge_base.dart)                â”‚
â”‚  â€¢ Pre-defined Routes                           â”‚
â”‚  â€¢ Bus Stop Data                                â”‚
â”‚  â€¢ Landmarks & Keywords                         â”‚
â”‚  â€¢ Metadata Storage                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ Implementation Details

### 1. **Vector Embeddings**

**Technology**: Google Gemini `text-embedding-004` model

**Process**:
- Each route is converted to text representation (name, description, stops, landmarks)
- Text is embedded into 384-dimensional vectors
- Vectors are cached in memory for fast retrieval

```dart
// Example embedding generation
final embedding = await _embeddingModel.embedContent(
  Content.text(routeText),
  taskType: TaskType.retrievalQuery,
);
```

**Fallback**: If API fails, uses simple hash-based embedding for offline functionality.

### 2. **Similarity Search**

**Algorithm**: Cosine Similarity

```dart
similarity = (A Â· B) / (||A|| Ã— ||B||)
```

**Scoring System**:
- 70% Vector similarity (semantic understanding)
- 30% Keyword matching (exact term matches)
- Threshold: >0.5 for "good match"

### 3. **Knowledge Base**

#### Pre-loaded Routes:

**Route 1: Mangalore to NMAMIT College**
- 7 bus stops
- 35+ km distance
- Landmarks: Hampankatta, NITK Surathkal, Nitte
- Keywords: mangalore, nmamit, engineering, nitte, surathkal

**Route 2: Mangalore to Udupi**
- 5 bus stops  
- 60+ km distance
- Landmarks: Kaup Beach, Lighthouse, Krishna Temple
- Keywords: udupi, coastal, beach, temple, pilgrimage

#### Data Structure:
```dart
class RouteInfo {
  String id, name, description;
  List<BusStop> stops;
  List<String> landmarks;
  List<String> keywords;
  double startLat, startLng, endLat, endLng;
}
```

### 4. **LLM Integration**

**Model**: Google Gemini 1.5 Flash

**Purpose**: Generate human-friendly responses with context

**Process**:
1. Retrieve top-K similar routes (K=2)
2. Build context from retrieved routes
3. Generate natural language response
4. Provide actionable information

**Fallback**: If API unavailable, returns structured text response without LLM.

## ğŸš€ Features

### Natural Language Queries

Users can ask in plain English:
- âœ… "How do I get to NMAMIT?"
- âœ… "Route from Mangalore to Nitte"
- âœ… "Bus stops near Surathkal"
- âœ… "Take me to engineering college"

### Intelligent Matching

- **Semantic Understanding**: Understands context and intent
- **Keyword Recognition**: Matches location names, landmarks
- **Fuzzy Matching**: Handles typos and variations
- **Multi-language**: Works with different phrasings

### Route Discovery

- **Match Scoring**: Shows confidence percentage
- **Matched Keywords**: Highlights relevant terms
- **Stop Details**: Complete list with sequence
- **Quick Load**: One-click to add stops to tracking

## ğŸ“± User Interface

### Main Features:

1. **Search Box**
   - Natural language input
   - Example query chips
   - Real-time search

2. **AI Response Card**
   - Generated by LLM
   - Human-friendly explanation
   - Actionable suggestions

3. **Route Match Cards**
   - Similarity percentage
   - Expandable details
   - Bus stop list
   - Load button

## ğŸ”‘ Setup Instructions

### 1. Get Gemini API Key

```bash
# Visit: https://makersuite.google.com/app/apikey
# Create a new API key
# Copy the key
```

### 2. Configure in Code

Open `lib/services/rag_service.dart`:

```dart
static const String _defaultApiKey = 'YOUR_GEMINI_API_KEY_HERE';
```

Replace with your actual API key:

```dart
static const String _defaultApiKey = 'AIza...your_key_here';
```

### 3. Initialize Service

```dart
final ragService = RAGService(apiKey: 'your_key');
await ragService.initialize();
```

## ğŸ’¡ How It Works

### Example Flow:

**User Query**: "How to reach NMAMIT from Mangalore?"

1. **Embedding**: Query converted to vector
2. **Retrieval**: Find similar routes (95% match with Route 1)
3. **Context**: Extract route details, stops, landmarks
4. **Generation**: LLM creates response:

```
Found route: Mangalore to NMAMIT College Nitte

Main route from Mangalore city to NMAM Institute of Technology 
in Nitte via NH66

Key stops: Mangalore Central â†’ Hampankatta â†’ Kottara â†’ Surathkal 
â†’ Katipalla

This route passes through: Hampankatta, NITK Surathkal, KMC Hospital
```

5. **Display**: Show response + route cards with load option

## ğŸ¨ Advanced Features

### Contextual Search

```dart
// Smart detection of start and end points
await ragService.suggestRoute('Mangalore', 'Nitte');
```

### Bus Stop Extraction

```dart
// Extract all relevant stops from query
final stops = await ragService.extractBusStops(query);
```

### Similarity Ranking

```dart
// Get top 3 most relevant routes
final matches = await ragService.findSimilarRoutes(query, topK: 3);
```

## ğŸ“Š Performance

- **Embedding Time**: ~200-500ms (with API)
- **Search Time**: ~50ms (in-memory vector search)
- **LLM Response**: ~1-2s (with Gemini API)
- **Offline Mode**: Works with fallback (no API needed)

## ğŸ”’ Privacy & Security

- **Local First**: Routes cached locally
- **Optional API**: Works without internet (degraded)
- **No User Data**: Queries not stored remotely
- **Secure Storage**: SharedPreferences for local data

## ğŸŒŸ Use Cases

### For Students
"Take me to NMAMIT college" â†’ Gets complete route with all stops

### For Tourists
"Udupi temple buses" â†’ Finds pilgrimage routes with landmarks

### For Commuters
"Surathkal to Nitte" â†’ Suggests best route with timings

### For Explorers
"What's near Kaup beach?" â†’ Discovers nearby stops and routes

## ğŸ”® Future Enhancements

- [ ] Voice input for queries
- [ ] Multi-language support (Kannada, Hindi)
- [ ] Real-time traffic integration
- [ ] User feedback for route quality
- [ ] Community-contributed routes
- [ ] Offline vector database (Hive/ObjectBox)
- [ ] Custom embeddings (fine-tuned for Indian locations)
- [ ] Integration with live bus APIs

## ğŸ› ï¸ Technical Stack

| Component | Technology |
|-----------|------------|
| Embeddings | Google Gemini text-embedding-004 |
| LLM | Google Gemini 1.5 Flash |
| Vector Math | Dart vector_math package |
| Storage | SharedPreferences |
| Search | Cosine similarity |
| Fallback | Hash-based embeddings |

## ğŸ“– API Reference

### RAGService

```dart
class RAGService {
  // Initialize with routes and embeddings
  Future<void> initialize();
  
  // Find similar routes
  Future<List<RouteMatch>> findSimilarRoutes(String query, {int topK});
  
  // Generate AI response
  Future<String> generateRouteResponse(String query);
  
  // Extract bus stops from query
  Future<List<BusStop>> extractBusStops(String query);
  
  // Suggest route by endpoints
  Future<RouteMatch?> suggestRoute(String start, String end);
}
```

### RouteMatch

```dart
class RouteMatch {
  RouteInfo route;
  double similarity;  // 0.0 to 1.0
  List<String> matchedKeywords;
  bool get isGoodMatch;  // similarity > 0.5
}
```

## ğŸ“ Learning Resources

- [RAG Overview](https://research.ibm.com/blog/retrieval-augmented-generation-RAG)
- [Vector Embeddings](https://platform.openai.com/docs/guides/embeddings)
- [Google Gemini Docs](https://ai.google.dev/docs)
- [Cosine Similarity](https://en.wikipedia.org/wiki/Cosine_similarity)

## ğŸ› Troubleshooting

### Issue: "API Key Error"
**Solution**: Set valid Gemini API key in `rag_service.dart`

### Issue: "No routes found"
**Solution**: Ensure knowledge base is initialized with `getPredefinedRoutes()`

### Issue: "Slow responses"
**Solution**: Embeddings are cached after first use, wait for initialization

### Issue: "Works offline?"
**Solution**: Yes! Uses fallback embeddings and structured responses

---

**Built with â¤ï¸ using Flutter, Dart, and Google Gemini AI**
